
- name: Install Python3
  ansible.builtin.apt:
    name: python3
    state: present

- name: Disable swap
  ansible.builtin.command: swapoff -a

- name: Disable swap
  ansible.builtin.replace:
    path: /etc/fstab
    regexp: "(^.*swap.*$)"
    replace: '# \1'

- name: Create file k8s.conf 
  ansible.builtin.file:
    path: /etc/modules-load.d/k8s.conf
    state: touch

- name: Add br_netfilter and overlay module
  ansible.builtin.lineinfile:
    path: /etc/modules-load.d/k8s.conf
    line: "{{ item }}"
  loop:
    - modprobe overlay
    - modprobe br_netfilter

- name: load modules
  ansible.builtin.command: "modprobe {{ item }}"
  loop:
    - overlay
    - br_netfilter

- name: Configure parameters for networking
  ansible.builtin.shell: |
    cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
    net.bridge.bridge-nf-call-iptables  = 1
    net.bridge.bridge-nf-call-ip6tables = 1
    net.ipv4.ip_forward                 = 1
    EOF

- name: Reload sysctl
  ansible.builtin.command: sysctl --system

- name: Update apt and install https transport
  ansible.builtin.shell: sudo apt-get update && sudo apt-get install -y apt-transport-https curl

- name: Add GPG key for kubernetes
  ansible.builtin.shell: |
    curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key \
    | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  args:
    creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

- name: Add kubernetes apt repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /"
    filename: kubernetes
    state: present

- name: Install
  ansible.builtin.apt:
    name: "{{ item }}"
    state: present
  loop:
    - kubelet
    - kubeadm
    - kubectl

- name: Mark all k8s packages to hold
  ansible.builtin.command: apt-mark hold kubelet kubeadm kubectl

- name: Install firewall
  ansible.builtin.apt:
    name: ufw
    state: present
    update_cache: yes

- name: Enable UFW
  community.general.ufw:
    state: enabled
    policy: allow

- name: Enable port 22
  community.general.ufw:
    rule: allow
    port: 22
  
- name: Configure firewall with shell
  ansible.builtin.shell: |
    ufw allow 6443/tcp
    ufw allow 2379:2380/tcp
    ufw allow 10250/tcp
    ufw allow 10251/tcp
    ufw allow 10252/tcp
    ufw allow 10255/tcp
    ufw allow 6783/tcp
    ufw allow 6783/udp
    ufw allow 6784/udp
    ufw --force enable


